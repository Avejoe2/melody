dom-module#melody-profile
  style.
    .melody-profile {
      width: 100%;
    }

  template
    .ui.grid.stackable
      .row
        .four.wide.column
          h2 {{item.name}}
          .ui.statistic
            .value {{item.stats.posts}}
            .label posts
        .twelve.wide.column
          melody-posts(src="/posts", filter="{ person: 'martindale' }", limit=20)
  script.
    Polymer({
      is: 'melody-profile',
      listeners: {
        'datastore:query':  '_handleQuery',
        'state:change':     '_applyState'
      },
      properties: {
        src: {
          type: String,
          observer: '_sourceChanged'
        },
        type: {
          type: Object
        },
        item: {
          type: Object,
          notify: true
        }
      },
      _handleQuery: function(e, key) {
        var self = this;
        var datastore = document.querySelector('maki-datastore[name=melody]');
        console.log('[MELODY:PROFILE]','_handleQuery:', e, key);
        if (!datastore) return console.error('[MELODY:PROFILE]', 'no datastore');
        datastore._retrieve(key, function(err, data) {
          console.log('[MELODY:PROFILE]', 'retrieve result:', err, data);
          if (!data) datastore.fire('datastore:miss', key);
          if (err) {
            console.error('_handleQuery error:', err);
            data = [];
          }
          self.fire('state:change', data);
        });
      },
      _applyState: function(e) {
        this.item = e.detail;
      },
      _sourceChanged: function(source) {
        var self = this;
        var melody = document.querySelector('melody-application');
        console.log('[MELODY:PROFILE]', '_sourceChanged:', source);
        
        // TODO: _sourceChanged is firing before the application exists (is
        // attached?), requiring this check.  There are many flow optimizations
        // to be made here.
        if (melody && melody.resourceMap) {
          //self.type = melody.resourceMap[source];
          self.type = melody.resourceMap['/people'];
        }
        
        self._sync();
      },
      _sync: function() {
        var self = this;
        console.log('[MELODY:PROFILE]', '_sync');
        self.fire('datastore:query', self.src);
      },
      ready: function() {
        var self = this;
        console.log('[MELODY:PROFILE]', 'ready');
        if (self.item) {
          self.src = '/people/' + self.item.slug;
        }
      },
      attached: function() {
        var self = this;
        console.log('[MELODY:PROFILE]', 'collection is attached:', self.src);
        var channel = document.querySelector('maki-channel');
        channel._subscribe(self.src);
      }
    });
